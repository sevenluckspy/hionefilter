<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>카메라 필터 앱</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/face-api.js/0.22.2/face-api.min.js"></script>
  </head>
  <body>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <script>
      async function init() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const earImg = new Image();
        const noseImg = new Image();
        const foreheadImg = new Image();

        const loadImages = () => {
          return new Promise((resolve, reject) => {
            let loadedImages = 0;
            const totalImages = 3;

            const onLoad = () => {
              loadedImages += 1;
              if (loadedImages === totalImages) {
                resolve();
              }
            };

            earImg.onload = onLoad;
            noseImg.onload = onLoad;
            foreheadImg.onload = onLoad;

            earImg.src = './귀.jpg';
            noseImg.src = './코.jpg';
            foreheadImg.src = './이마.jpg';
          });
        };

        await faceapi.nets.ssdMobilenetv1.loadFromUri('./models');
        await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
        await loadImages();

        navigator.mediaDevices.getUserMedia({ video: true, audio: false })
          .then(stream => {
            video.srcObject = stream;
            video.play();
          })
          .catch(err => {
            console.error(err);
          });

        function draw() {
          // Draw video frame onto canvas
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          // Detect all faces and draw face landmarks on canvas
          faceapi.detectAllFaces(video, new faceapi.SsdMobilenetv1Options()).withFaceLandmarks().then((result) => {
            result.forEach((face) => {
              // Get forehead, nose, and ear positions
              const forehead = face.landmarks.getNose()[0];
              const nose = face.landmarks.getNose()[6];
              const leftEar = face.landmarks.positions[0];
              const rightEar = face.landmarks.positions[16];

              // Draw images on each facial feature
              ctx.drawImage(earImg, leftEar.x - (earImg.width / 2), leftEar.y - (earImg.height / 2), earImg.width, earImg.height);
              ctx.drawImage(earImg, rightEar.x - (earImg.width / 2), rightEar.y - (earImg.height / 2), earImg.width, earImg.height);
              ctx.drawImage(noseImg, nose.x - (noseImg.width / 2), nose.y - (noseImg.height / 2), noseImg.width, noseImg.height);
              ctx.drawImage(foreheadImg, forehead.x - (foreheadImg.width / 2), forehead.y - (foreheadImg.height / 2) - 20, foreheadImg.width, foreheadImg.height);
            });
            requestAnimationFrame(draw);
          });
        }

        video.addEventListener('play', () => {
          requestAnimationFrame(draw);
        });
      }

      window.addEventListener('load', init);

    </script>
  </body>